project_name= "TradeFuture"
scheme = 'TradeFuture'
build_configuration = "Release"
project_path = "./#{project_name}.xcodeproj"
# export_method = "app-store"
cached_derived_data_path = File.expand_path("../cached_derived_data")
cache_folder = File.expand_path("#{cached_derived_data_path}/Build/Intermediates.noindex/ArchiveIntermediates/#{scheme}/BuildProductsPath/#{build_configuration}-iphoneos")
intermediates_path = "#{cached_derived_data_path}/Build/Intermediates.noindex/ArchiveIntermediates/#{project_name}"

# export_method is either "app-store" or "ad-hoc" depending on where its being sent.
export_method = ENV["SIGN_TYPE"]

# prov_profile is the name of the provisioning profile - ie: "DevOps Distribution v2"
prov_profile = ENV["PROV_PROFILE_NAME"]

# view the profile in finder to get the UUID
# prov_profile_uuid = ENV["APPLE_PROV_PROFILE_UUID"]

# signing ID will be automatically set by the CI
# signing_identity = ENV["APPLE_CERTIFICATE_SIGNING_IDENTITY"]


default_platform(:ios)

platform :ios do

  desc "Build iOS app"
  lane :build_ios do

    update_code_signing_settings(
      path:"#{project_name}.xcodeproj",
      use_automatic_signing: false,
      profile_name: prov_profile,
      # profile_uuid: prov_profile_uuid
    )

    build_app(
      workspace: "#{project_name}.xcworkspace",
      scheme: project_name,
      # export_xcargs: "-allowProvisioningUpdates",
      export_method: export_method,
      output_directory: "output/package",
      archive_path: "output/archive",
      export_team_id: "32864LVP55",
      export_xcargs: "-allowProvisioningUpdates",
      export_options: {
        compileBitcode: false,
        uploadBitcode: false,
        uploadSymbols: false,
        method: export_method,
        stripSwiftSymbols: true,
        teamID: "32864LVP55",
        # signingStyle: "manual",
        # signingCertificate: signing_identity,
        thinning: "<none>",
        # provisioningProfiles: {
        #   "com.tradeFuture.app" => prov_profile
        # }
      },
      # xcargs: [
      #   # "PROVISIONING_PROFILE_SPECIFIER='#{prov_profile}'",
      #   # "PROVISIONING_PROFILE_SPECIFIER='DevOps - App Store Distribution'",
      #   "CODE_SIGN_STYLE=Manual",
      #   # "CODE_SIGN_IDENTITY='iPhone Distribution: Insite Work Pty Ltd (G77MP8SP8H)'"
      #   "CODE_SIGN_IDENTITY='#{signing_identity}'"
      # ].join(" ")
    )
    sh "curl https://upload.diawi.com/ -F token=#{ENV['DIAWI_TOKEN']} -F file=@./output/package/insitework.ipa"

  end


end